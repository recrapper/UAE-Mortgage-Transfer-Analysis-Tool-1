<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UAE Mortgage Transfer Analysis Tool</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }
        
        .header p {
            font-size: 1.1rem;
            opacity: 0.95;
        }
        
        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        @media (max-width: 968px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            animation: fadeInUp 0.8s ease;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }
        
        .card-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 1.5rem;
        }
        
        .current-icon {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .new-icon {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .costs-icon {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }
        
        .analysis-icon {
            background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);
        }
        
        .schedule-icon {
            background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: #2d3748;
        }
        
        .input-group {
            margin-bottom: 20px;
        }
        
        .input-label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .input-wrapper {
            position: relative;
        }
        
        .input-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .input-addon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-weight: 500;
        }
        
        select.input-field {
            cursor: pointer;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }
        
        .radio-option {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-option input[type="radio"] {
            margin-right: 8px;
            cursor: pointer;
        }
        
        .help-text {
            font-size: 0.85rem;
            color: #718096;
            margin-top: 5px;
            font-style: italic;
        }
        
        .costs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .cost-input-group {
            background: #f7fafc;
            border-radius: 10px;
            padding: 15px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .cost-input-group:hover {
            border-color: #e2e8f0;
        }
        
        .cost-input-group.auto-calculated {
            background: #ebf8ff;
        }
        
        .cost-input-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .cost-input-field {
            flex: 1;
            padding: 10px 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
        }
        
        .cost-input-field:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .cost-auto-toggle {
            display: flex;
            align-items: center;
            gap: 5px;
            margin-top: 8px;
            font-size: 0.85rem;
            color: #4a5568;
        }
        
        .cost-auto-toggle input[type="checkbox"] {
            cursor: pointer;
        }
        
        .cost-calculation-info {
            background: white;
            border-radius: 8px;
            padding: 8px 10px;
            margin-top: 8px;
            font-size: 0.8rem;
            color: #2d3748;
            border: 1px solid #e2e8f0;
        }
        
        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .result-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 15px;
            padding: 20px;
            color: white;
            text-align: center;
            transform: translateY(0);
            transition: transform 0.3s ease;
        }
        
        .result-box:hover {
            transform: translateY(-5px);
        }
        
        .result-label {
            font-size: 0.9rem;
            opacity: 0.9;
            margin-bottom: 8px;
        }
        
        .result-value {
            font-size: 1.8rem;
            font-weight: 700;
        }
        
        .result-subtext {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-top: 5px;
        }
        
        .positive {
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        }
        
        .negative {
            background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
        }
        
        .neutral {
            background: linear-gradient(135deg, #8e9eab 0%, #eef2f3 100%);
            color: #2d3748;
        }
        
        .calculate-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }
        
        .reset-costs-btn {
            padding: 10px 20px;
            background: #718096;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-bottom: 15px;
        }
        
        .reset-costs-btn:hover {
            background: #4a5568;
        }
        
        .breakdown-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
        }
        
        .breakdown-table th {
            background: #f7fafc;
            padding: 12px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        
        .breakdown-table td {
            padding: 12px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        .breakdown-table tr:hover {
            background: #f7fafc;
        }
        
        .chart-container {
            margin-top: 30px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }
        
        #savingsChart {
            max-width: 100%;
            height: 300px;
        }
        
        .warning-box {
            background: #fff5f5;
            border: 2px solid #feb2b2;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #c53030;
        }
        
        .success-box {
            background: #f0fff4;
            border: 2px solid #9ae6b4;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #22543d;
        }
        
        .info-box {
            background: #ebf8ff;
            border: 2px solid #90cdf4;
            border-radius: 10px;
            padding: 15px;
            margin-top: 20px;
            color: #2c5282;
        }
        
        .tooltip {
            position: relative;
            display: inline-block;
            margin-left: 5px;
            cursor: help;
        }
        
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 250px;
            background-color: #2d3748;
            color: white;
            text-align: left;
            border-radius: 8px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -125px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.85rem;
            line-height: 1.4;
        }
        
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        
        .schedule-table {
            width: 100%;
            margin-top: 20px;
            border-collapse: collapse;
            font-size: 0.9rem;
        }
        
        .schedule-table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 10px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .schedule-table td {
            padding: 8px;
            text-align: right;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .schedule-table tr:nth-child(even) {
            background: #f7fafc;
        }
        
        .schedule-table tr:hover {
            background: #edf2f7;
        }
        
        .schedule-table .year-header {
            background: #4a5568;
            color: white;
            font-weight: 600;
            text-align: center;
        }
        
        .schedule-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .schedule-toggle {
            padding: 8px 16px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.3s ease;
        }
        
        .schedule-toggle:hover {
            background: #5a67d8;
        }
        
        .schedule-toggle.active {
            background: #764ba2;
        }
        
        .comparison-header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }
        
        .new-header {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }
        
        .savings-cell {
            color: #22543d;
            font-weight: 600;
        }
        
        .schedule-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
            padding: 20px;
            background: #f7fafc;
            border-radius: 15px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            color: #718096;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        
        .summary-value {
            color: #2d3748;
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .total-costs-summary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            text-align: center;
        }
        
        .total-costs-label {
            font-size: 1rem;
            opacity: 0.95;
            margin-bottom: 10px;
        }
        
        .total-costs-value {
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        @keyframes fadeInDown {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🏦 UAE Mortgage Transfer Analysis Tool</h1>
            <p>Comprehensive refinancing calculator with customizable costs and complete repayment schedules</p>
        </div>
        
        <div class="main-grid">
            <!-- Current Mortgage Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon current-icon">📊</div>
                    <h2 class="card-title">Current Mortgage Details</h2>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        Property Value (AED)
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Current market value of your property. This affects LTV ratios and may impact available rates.</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="propertyValue" class="input-field" value="1500000" min="0">
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Outstanding Loan Amount (AED)</label>
                    <div class="input-wrapper">
                        <input type="number" id="currentBalance" class="input-field" value="1200000" min="0">
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Current Interest Rate (%)</label>
                    <div class="input-wrapper">
                        <input type="number" id="currentRate" class="input-field" value="3.99" min="0" max="20" step="0.01">
                        <span class="input-addon">%</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Remaining Term (Years)</label>
                    <div class="input-wrapper">
                        <input type="number" id="remainingYears" class="input-field" value="7" min="1" max="25">
                    </div>
                    <p class="help-text">Years left on your current mortgage</p>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Borrower Type</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="borrowerType" value="national" checked>
                            UAE National
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="borrowerType" value="expat">
                            Expatriate
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- New Mortgage Card -->
            <div class="card">
                <div class="card-header">
                    <div class="card-icon new-icon">🎯</div>
                    <h2 class="card-title">New Mortgage Offer</h2>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        New Interest Rate (%)
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Current market rates range from 3.89% to 6.65%. Check with banks for your specific rate based on salary transfer and relationship.</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="newRate" class="input-field" value="3.5" min="0" max="20" step="0.01">
                        <span class="input-addon">%</span>
                    </div>
                </div>
                
                <div class="input-group">
                    <label class="input-label">Salary Transfer to New Bank?</label>
                    <div class="radio-group">
                        <label class="radio-option">
                            <input type="radio" name="salaryTransfer" value="yes">
                            Yes
                        </label>
                        <label class="radio-option">
                            <input type="radio" name="salaryTransfer" value="no" checked>
                            No
                        </label>
                    </div>
                    <p class="help-text">Salary transfer can reduce rates by 0.25-0.5% and reduce some fees</p>
                </div>
                
                <div class="input-group">
                    <label class="input-label">
                        New Loan Term (Years)
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">You can choose the same remaining term or extend it for lower monthly payments (but higher total interest).</span>
                        </span>
                    </label>
                    <div class="input-wrapper">
                        <input type="number" id="newTerm" class="input-field" value="7" min="1" max="25">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Transfer Costs Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon costs-icon">💰</div>
                <h2 class="card-title">Refinancing Costs - Customizable</h2>
            </div>
            
            <button class="reset-costs-btn" onclick="resetCostsToDefaults()">
                🔄 Reset to Default Values
            </button>
            
            <div class="costs-grid">
                <!-- Early Settlement Fee -->
                <div class="cost-input-group" id="earlySettlement-group">
                    <label class="input-label">
                        Early Settlement Fee
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Current bank penalty for early loan closure. Usually 1% of outstanding balance, capped at AED 10,000</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="earlySettlement" class="cost-input-field" min="0">
                    </div>
                    <div class="cost-auto-toggle">
                        <input type="checkbox" id="earlySettlement-auto" checked onchange="toggleAutoCalculation('earlySettlement')">
                        <label for="earlySettlement-auto">Auto-calculate (1% capped at 10,000)</label>
                    </div>
                </div>
                
                <!-- Processing Fee -->
                <div class="cost-input-group" id="processingFee-group">
                    <label class="input-label">
                        Processing Fee (New Bank)
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">New bank's processing fee. Standard is 0.525% of loan amount. Often waived for refinancing.</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="processingFee" class="cost-input-field" min="0">
                    </div>
                    <div class="cost-auto-toggle">
                        <input type="checkbox" id="processingFee-auto" checked onchange="toggleAutoCalculation('processingFee')">
                        <label for="processingFee-auto">Auto-calculate (0.525% if not waived)</label>
                    </div>
                </div>
                
                <!-- Property Valuation -->
                <div class="cost-input-group">
                    <label class="input-label">
                        Property Valuation
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Professional property valuation required by new bank. Typically AED 2,500-4,500 including VAT</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="valuation" class="cost-input-field" value="3500" min="0">
                    </div>
                </div>
                
                <!-- Mortgage Registration -->
                <div class="cost-input-group" id="mortgageRegistration-group">
                    <label class="input-label">
                        Mortgage Registration (DLD)
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Dubai Land Department fee for registering new mortgage. 0.25% of loan + AED 290</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="mortgageRegistration" class="cost-input-field" min="0">
                    </div>
                    <div class="cost-auto-toggle">
                        <input type="checkbox" id="mortgageRegistration-auto" checked onchange="toggleAutoCalculation('mortgageRegistration')">
                        <label for="mortgageRegistration-auto">Auto-calculate (0.25% + 290)</label>
                    </div>
                </div>
                
                <!-- Mortgage De-registration -->
                <div class="cost-input-group">
                    <label class="input-label">
                        Mortgage De-registration
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">DLD fee for canceling existing mortgage. Fixed fee of AED 1,590</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="mortgageDeregistration" class="cost-input-field" value="1590" min="0">
                    </div>
                </div>
                
                <!-- Service Partner Fees -->
                <div class="cost-input-group">
                    <label class="input-label">
                        Service Partner/Trustee Fees
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Fees for mortgage registration services. Usually AED 3,000-6,000</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="servicePartner" class="cost-input-field" value="4500" min="0">
                    </div>
                </div>
                
                <!-- Life Insurance -->
                <div class="cost-input-group" id="lifeInsurance-group">
                    <label class="input-label">
                        Life Insurance (Year 1)
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">First year's life insurance premium. Typically 0.4-0.8% of loan amount annually</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="lifeInsurance" class="cost-input-field" min="0">
                    </div>
                    <div class="cost-auto-toggle">
                        <input type="checkbox" id="lifeInsurance-auto" checked onchange="toggleAutoCalculation('lifeInsurance')">
                        <label for="lifeInsurance-auto">Auto-calculate (0.6% of loan)</label>
                    </div>
                </div>
                
                <!-- Legal & Admin -->
                <div class="cost-input-group">
                    <label class="input-label">
                        Legal & Administrative
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">Legal documentation, bank admin fees, NOCs. Usually AED 5,000-10,000</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="legalAdmin" class="cost-input-field" value="7500" min="0">
                    </div>
                </div>
                
                <!-- Miscellaneous -->
                <div class="cost-input-group">
                    <label class="input-label">
                        Miscellaneous Costs
                        <span class="tooltip">ℹ️
                            <span class="tooltiptext">DEWA clearance, courier, documentation, etc. Usually AED 1,500-3,000</span>
                        </span>
                    </label>
                    <div class="cost-input-wrapper">
                        <span>AED</span>
                        <input type="number" id="miscellaneous" class="cost-input-field" value="2000" min="0">
                    </div>
                </div>
            </div>
            
            <div class="total-costs-summary">
                <div class="total-costs-label">Total Refinancing Costs</div>
                <div class="total-costs-value" id="totalCostsDisplay">AED 0</div>
            </div>
            
            <table class="breakdown-table">
                <thead>
                    <tr>
                        <th>Cost Component</th>
                        <th>Amount (AED)</th>
                        <th>Notes</th>
                    </tr>
                </thead>
                <tbody id="costBreakdown">
                    <!-- Table rows will be populated here -->
                </tbody>
            </table>
        </div>
        
        <!-- Analysis Results Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon analysis-icon">📈</div>
                <h2 class="card-title">Financial Analysis & Recommendations</h2>
            </div>
            
            <button class="calculate-btn" onclick="calculateTransfer()">
                Calculate Transfer Analysis
            </button>
            
            <div id="resultsSection" class="hidden">
                <div class="results-grid" id="analysisGrid">
                    <!-- Analysis results will be populated here -->
                </div>
                
                <div id="recommendation">
                    <!-- Recommendation will be shown here -->
                </div>
                
                <div class="chart-container">
                    <canvas id="savingsChart"></canvas>
                </div>
                
                <table class="breakdown-table">
                    <thead>
                        <tr>
                            <th>Time Period</th>
                            <th>Cumulative Savings</th>
                            <th>Net Position</th>
                        </tr>
                    </thead>
                    <tbody id="savingsBreakdown">
                        <!-- Savings timeline will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Loan Repayment Schedule Card -->
        <div class="card">
            <div class="card-header">
                <div class="card-icon schedule-icon">📅</div>
                <h2 class="card-title">Loan Repayment Schedule Comparison</h2>
            </div>
            
            <div id="scheduleSection" class="hidden">
                <div class="schedule-controls">
                    <button class="schedule-toggle active" onclick="toggleScheduleView('annual')">Annual View</button>
                    <button class="schedule-toggle" onclick="toggleScheduleView('monthly')">Monthly View</button>
                    <span style="margin-left: auto; color: #718096; font-size: 0.9rem;">
                        Showing comparison between current and new mortgage terms
                    </span>
                </div>
                
                <div class="schedule-summary">
                    <div class="summary-item">
                        <div class="summary-label">Total Interest - Current</div>
                        <div class="summary-value" id="totalInterestCurrent">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Total Interest - New</div>
                        <div class="summary-value" id="totalInterestNew">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Interest Saved</div>
                        <div class="summary-value" id="totalInterestSaved" style="color: #22543d;">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Final Payment Date - Current</div>
                        <div class="summary-value" id="finalDateCurrent" style="font-size: 1.2rem;">-</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Final Payment Date - New</div>
                        <div class="summary-value" id="finalDateNew" style="font-size: 1.2rem;">-</div>
                    </div>
                </div>
                
                <div style="overflow-x: auto; margin-top: 20px;">
                    <table class="schedule-table" id="scheduleTable">
                        <thead id="scheduleHeader">
                            <!-- Header will be populated based on view -->
                        </thead>
                        <tbody id="scheduleBody">
                            <!-- Schedule will be populated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Initialize chart variable
        let savingsChart = null;
        let currentScheduleView = 'annual';
        let amortizationData = {};
        
        // Cost component auto-calculation settings
        const autoCalculationSettings = {
            earlySettlement: true,
            processingFee: true,
            mortgageRegistration: true,
            lifeInsurance: true
        };
        
        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-AE', {
                style: 'currency',
                currency: 'AED',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(amount);
        }
        
        // Calculate monthly payment using standard amortization formula
        function calculateMonthlyPayment(principal, rate, years) {
            const monthlyRate = rate / 100 / 12;
            const months = years * 12;
            
            if (monthlyRate === 0) {
                return principal / months;
            }
            
            const payment = principal * 
                (monthlyRate * Math.pow(1 + monthlyRate, months)) / 
                (Math.pow(1 + monthlyRate, months) - 1);
            
            return payment;
        }
        
        // Generate complete amortization schedule
        function generateAmortizationSchedule(principal, annualRate, years, startDate = new Date()) {
            const monthlyRate = annualRate / 100 / 12;
            const totalMonths = years * 12;
            const monthlyPayment = calculateMonthlyPayment(principal, annualRate, years);
            
            let balance = principal;
            const schedule = [];
            let totalInterest = 0;
            let currentDate = new Date(startDate);
            
            for (let month = 1; month <= totalMonths; month++) {
                const interestPayment = balance * monthlyRate;
                const principalPayment = monthlyPayment - interestPayment;
                balance = Math.max(0, balance - principalPayment);
                totalInterest += interestPayment;
                
                // Move to next month
                currentDate.setMonth(currentDate.getMonth() + 1);
                
                schedule.push({
                    month: month,
                    year: Math.ceil(month / 12),
                    date: new Date(currentDate),
                    payment: monthlyPayment,
                    principal: principalPayment,
                    interest: interestPayment,
                    balance: balance,
                    cumulativeInterest: totalInterest,
                    cumulativePrincipal: principal - balance
                });
            }
            
            return {
                schedule: schedule,
                totalInterest: totalInterest,
                totalPayments: monthlyPayment * totalMonths,
                monthlyPayment: monthlyPayment
            };
        }
        
        // Toggle auto-calculation for a specific cost component
        function toggleAutoCalculation(component) {
            autoCalculationSettings[component] = document.getElementById(`${component}-auto`).checked;
            const input = document.getElementById(component);
            const group = document.getElementById(`${component}-group`);
            
            if (autoCalculationSettings[component]) {
                input.readOnly = true;
                group.classList.add('auto-calculated');
                // Recalculate the auto values
                updateAutoCalculatedCosts();
            } else {
                input.readOnly = false;
                group.classList.remove('auto-calculated');
            }
            
            updateTotalCostsDisplay();
        }
        
        // Update auto-calculated cost values
        function updateAutoCalculatedCosts() {
            const balance = parseFloat(document.getElementById('currentBalance').value) || 0;
            const salaryTransfer = document.querySelector('input[name="salaryTransfer"]:checked').value === 'yes';
            
            // Early Settlement Fee
            if (autoCalculationSettings.earlySettlement) {
                document.getElementById('earlySettlement').value = Math.min(balance * 0.01, 10000);
            }
            
            // Processing Fee
            if (autoCalculationSettings.processingFee) {
                const processingWaived = document.querySelector('input[name="salaryTransfer"]:checked').value === 'yes';
                document.getElementById('processingFee').value = processingWaived ? 0 : balance * 0.00525;
            }
            
            // Mortgage Registration
            if (autoCalculationSettings.mortgageRegistration) {
                document.getElementById('mortgageRegistration').value = balance * 0.0025 + 290;
            }
            
            // Life Insurance
            if (autoCalculationSettings.lifeInsurance) {
                document.getElementById('lifeInsurance').value = balance * 0.006;
            }
            
            // Apply salary transfer discounts to manual fields
            const legalAdmin = parseFloat(document.getElementById('legalAdmin').value) || 7500;
            const servicePartner = parseFloat(document.getElementById('servicePartner').value) || 4500;
            
            if (salaryTransfer) {
                // Store original values if not already stored
                if (!document.getElementById('legalAdmin').dataset.original) {
                    document.getElementById('legalAdmin').dataset.original = legalAdmin;
                    document.getElementById('servicePartner').dataset.original = servicePartner;
                }
            } else {
                // Restore original values if they exist
                if (document.getElementById('legalAdmin').dataset.original) {
                    document.getElementById('legalAdmin').value = document.getElementById('legalAdmin').dataset.original;
                    document.getElementById('servicePartner').value = document.getElementById('servicePartner').dataset.original;
                }
            }
        }
        
        // Reset costs to default values
        function resetCostsToDefaults() {
            // Set all auto-calculation checkboxes to checked
            document.getElementById('earlySettlement-auto').checked = true;
            document.getElementById('processingFee-auto').checked = true;
            document.getElementById('mortgageRegistration-auto').checked = true;
            document.getElementById('lifeInsurance-auto').checked = true;
            
            // Update auto-calculation settings
            autoCalculationSettings.earlySettlement = true;
            autoCalculationSettings.processingFee = true;
            autoCalculationSettings.mortgageRegistration = true;
            autoCalculationSettings.lifeInsurance = true;
            
            // Set manual field defaults
            document.getElementById('valuation').value = 3500;
            document.getElementById('mortgageDeregistration').value = 1590;
            document.getElementById('servicePartner').value = 4500;
            document.getElementById('legalAdmin').value = 7500;
            document.getElementById('miscellaneous').value = 2000;
            
            // Clear stored original values
            document.getElementById('legalAdmin').removeAttribute('data-original');
            document.getElementById('servicePartner').removeAttribute('data-original');
            
            // Update auto-calculated values
            updateAutoCalculatedCosts();
            
            // Update display
            updateTotalCostsDisplay();
            
            // Add visual feedback
            document.querySelectorAll('.cost-input-group').forEach(group => {
                if (group.querySelector('input[type="checkbox"]:checked')) {
                    group.classList.add('auto-calculated');
                } else {
                    group.classList.remove('auto-calculated');
                }
            });
        }
        
        // Get all transfer costs (both auto-calculated and manual)
        function getTransferCosts() {
            const costs = {
                earlySettlement: parseFloat(document.getElementById('earlySettlement').value) || 0,
                processingFee: parseFloat(document.getElementById('processingFee').value) || 0,
                valuation: parseFloat(document.getElementById('valuation').value) || 0,
                mortgageRegistration: parseFloat(document.getElementById('mortgageRegistration').value) || 0,
                mortgageDeregistration: parseFloat(document.getElementById('mortgageDeregistration').value) || 0,
                servicePartner: parseFloat(document.getElementById('servicePartner').value) || 0,
                lifeInsurance: parseFloat(document.getElementById('lifeInsurance').value) || 0,
                legalAdmin: parseFloat(document.getElementById('legalAdmin').value) || 0,
                miscellaneous: parseFloat(document.getElementById('miscellaneous').value) || 0
            };
            
            costs.total = Object.values(costs).reduce((sum, cost) => sum + cost, 0);
            
            return costs;
        }
        
        // Update total costs display
        function updateTotalCostsDisplay() {
            const costs = getTransferCosts();
            document.getElementById('totalCostsDisplay').textContent = formatCurrency(costs.total);
        }
        
        // Toggle between annual and monthly schedule views
        function toggleScheduleView(view) {
            currentScheduleView = view;
            
            // Update button states
            document.querySelectorAll('.schedule-toggle').forEach(btn => {
                btn.classList.remove('active');
                if (btn.textContent.toLowerCase().includes(view)) {
                    btn.classList.add('active');
                }
            });
            
            // Regenerate the schedule display
            if (amortizationData.current && amortizationData.new) {
                displayRepaymentSchedule(amortizationData.current, amortizationData.new);
            }
        }
        
        // Display the repayment schedule
        function displayRepaymentSchedule(currentAmortization, newAmortization) {
            const header = document.getElementById('scheduleHeader');
            const body = document.getElementById('scheduleBody');
            
            // Create header based on view type
            if (currentScheduleView === 'annual') {
                header.innerHTML = `
                    <tr>
                        <th rowspan="2">Year</th>
                        <th colspan="4" class="comparison-header">Current Mortgage</th>
                        <th colspan="4" class="new-header">New Mortgage</th>
                        <th rowspan="2">Annual<br>Savings</th>
                    </tr>
                    <tr>
                        <th class="comparison-header">Payment</th>
                        <th class="comparison-header">Principal</th>
                        <th class="comparison-header">Interest</th>
                        <th class="comparison-header">Balance</th>
                        <th class="new-header">Payment</th>
                        <th class="new-header">Principal</th>
                        <th class="new-header">Interest</th>
                        <th class="new-header">Balance</th>
                    </tr>
                `;
                
                // Generate annual summary data
                const annualData = [];
                const currentYears = Math.ceil(currentAmortization.schedule.length / 12);
                const newYears = Math.ceil(newAmortization.schedule.length / 12);
                const maxYears = Math.max(currentYears, newYears);
                
                for (let year = 1; year <= maxYears; year++) {
                    const currentYearData = currentAmortization.schedule
                        .filter(m => m.year === year)
                        .reduce((acc, m) => ({
                            payment: acc.payment + m.payment,
                            principal: acc.principal + m.principal,
                            interest: acc.interest + m.interest,
                            balance: m.balance // Take last balance of the year
                        }), { payment: 0, principal: 0, interest: 0, balance: 0 });
                    
                    const newYearData = newAmortization.schedule
                        .filter(m => m.year === year)
                        .reduce((acc, m) => ({
                            payment: acc.payment + m.payment,
                            principal: acc.principal + m.principal,
                            interest: acc.interest + m.interest,
                            balance: m.balance
                        }), { payment: 0, principal: 0, interest: 0, balance: 0 });
                    
                    annualData.push({
                        year: year,
                        current: currentYearData,
                        new: newYearData,
                        savings: currentYearData.payment - newYearData.payment
                    });
                }
                
                // Populate annual view
                body.innerHTML = annualData.map(data => `
                    <tr>
                        <td style="text-align: center; font-weight: 600;">Year ${data.year}</td>
                        <td>${formatCurrency(data.current.payment)}</td>
                        <td>${formatCurrency(data.current.principal)}</td>
                        <td>${formatCurrency(data.current.interest)}</td>
                        <td>${formatCurrency(data.current.balance)}</td>
                        <td>${formatCurrency(data.new.payment)}</td>
                        <td>${formatCurrency(data.new.principal)}</td>
                        <td>${formatCurrency(data.new.interest)}</td>
                        <td>${formatCurrency(data.new.balance)}</td>
                        <td class="savings-cell">${formatCurrency(data.savings)}</td>
                    </tr>
                `).join('');
                
            } else {
                // Monthly view - show first 24 months and then every 12th month
                header.innerHTML = `
                    <tr>
                        <th rowspan="2">Month</th>
                        <th colspan="3" class="comparison-header">Current Mortgage</th>
                        <th colspan="3" class="new-header">New Mortgage</th>
                        <th rowspan="2">Monthly<br>Savings</th>
                    </tr>
                    <tr>
                        <th class="comparison-header">Payment</th>
                        <th class="comparison-header">Interest</th>
                        <th class="comparison-header">Balance</th>
                        <th class="new-header">Payment</th>
                        <th class="new-header">Interest</th>
                        <th class="new-header">Balance</th>
                    </tr>
                `;
                
                const monthsToShow = [];
                const totalMonths = Math.max(currentAmortization.schedule.length, newAmortization.schedule.length);
                
                // Show first 24 months, then every 12th month
                for (let i = 1; i <= totalMonths; i++) {
                    if (i <= 24 || i % 12 === 0) {
                        monthsToShow.push(i);
                    }
                }
                
                body.innerHTML = monthsToShow.map(month => {
                    const currentMonth = currentAmortization.schedule[month - 1] || {};
                    const newMonth = newAmortization.schedule[month - 1] || {};
                    
                    return `
                        <tr>
                            <td style="text-align: center; font-weight: 600;">
                                ${month}
                                ${month > 24 && month % 12 === 0 ? ` (Yr ${month/12})` : ''}
                            </td>
                            <td>${currentMonth.payment ? formatCurrency(currentMonth.payment) : '-'}</td>
                            <td>${currentMonth.interest ? formatCurrency(currentMonth.interest) : '-'}</td>
                            <td>${currentMonth.balance !== undefined ? formatCurrency(currentMonth.balance) : '-'}</td>
                            <td>${newMonth.payment ? formatCurrency(newMonth.payment) : '-'}</td>
                            <td>${newMonth.interest ? formatCurrency(newMonth.interest) : '-'}</td>
                            <td>${newMonth.balance !== undefined ? formatCurrency(newMonth.balance) : '-'}</td>
                            <td class="savings-cell">
                                ${formatCurrency((currentMonth.payment || 0) - (newMonth.payment || 0))}
                            </td>
                        </tr>
                    `;
                }).join('');
            }
        }
        
        // Main calculation function
        function calculateTransfer() {
            // First update auto-calculated costs
            updateAutoCalculatedCosts();
            
            // Get all input values
            const propertyValue = parseFloat(document.getElementById('propertyValue').value) || 0;
            const currentBalance = parseFloat(document.getElementById('currentBalance').value) || 0;
            const currentRate = parseFloat(document.getElementById('currentRate').value) || 0;
            const newRate = parseFloat(document.getElementById('newRate').value) || 0;
            const remainingYears = parseFloat(document.getElementById('remainingYears').value) || 0;
            const newTerm = parseFloat(document.getElementById('newTerm').value) || remainingYears;
            const borrowerType = document.querySelector('input[name="borrowerType"]:checked').value;
            const salaryTransfer = document.querySelector('input[name="salaryTransfer"]:checked').value === 'yes';
            
            // Calculate LTV ratio
            const ltv = (currentBalance / propertyValue) * 100;
            
            // Check if LTV is within regulatory limits
            const maxLTV = borrowerType === 'national' ? 85 : 80;
            if (ltv > maxLTV) {
                alert(`Warning: Your LTV ratio (${ltv.toFixed(1)}%) exceeds the regulatory maximum of ${maxLTV}% for ${borrowerType === 'national' ? 'UAE nationals' : 'expatriates'}. You may need to pay down some principal.`);
            }
            
            // Generate amortization schedules
            const currentAmortization = generateAmortizationSchedule(currentBalance, currentRate, remainingYears);
            const newAmortization = generateAmortizationSchedule(currentBalance, newRate, newTerm);
            
            // Store for later use
            amortizationData = {
                current: currentAmortization,
                new: newAmortization
            };
            
            // Calculate monthly savings
            const monthlySavings = currentAmortization.monthlyPayment - newAmortization.monthlyPayment;
            
            // Get transfer costs
            const costs = getTransferCosts();
            
            // Update costs display
            updateCostsDisplay(costs);
            
            // Calculate break-even and total savings
            const monthsToBreakeven = monthlySavings > 0 ? Math.ceil(costs.total / monthlySavings) : Infinity;
            
            // For total savings, we need to consider the actual term difference
            let totalSavings;
            if (newTerm === remainingYears) {
                // Same term - simple calculation
                totalSavings = currentAmortization.totalInterest - newAmortization.totalInterest - costs.total;
            } else {
                // Different terms - compare total cost over the period
                const currentTotalCost = currentAmortization.totalPayments;
                const newTotalCost = newAmortization.totalPayments + costs.total;
                totalSavings = currentTotalCost - newTotalCost;
            }
            
            const annualSavings = monthlySavings * 12;
            
            // Calculate effective rate reduction
            const effectiveRateReduction = currentRate - newRate;
            
            // Generate recommendation
            let recommendation = '';
            let recommendationClass = '';
            
            if (monthlySavings <= 0 && newTerm <= remainingYears) {
                recommendation = "❌ <strong>Not Recommended:</strong> The new rate is not better than your current rate. Refinancing would increase your costs.";
                recommendationClass = 'warning-box';
            } else if (newTerm > remainingYears && totalSavings < 0) {
                recommendation = "⚠️ <strong>Caution:</strong> While your monthly payment decreases, extending the loan term increases total interest paid. Consider keeping the same term.";
                recommendationClass = 'warning-box';
            } else if (monthsToBreakeven > 36) {
                recommendation = "⚠️ <strong>Marginal Benefit:</strong> The break-even period exceeds 3 years. Consider this carefully based on your long-term plans.";
                recommendationClass = 'warning-box';
            } else if (monthsToBreakeven <= 18 && totalSavings > 50000) {
                recommendation = "✅ <strong>Highly Recommended:</strong> Excellent refinancing opportunity with quick payback and substantial savings.";
                recommendationClass = 'success-box';
            } else if (monthsToBreakeven <= 24) {
                recommendation = "✅ <strong>Recommended:</strong> Good refinancing opportunity with reasonable payback period.";
                recommendationClass = 'success-box';
            } else {
                recommendation = "ℹ️ <strong>Consider Carefully:</strong> Moderate benefits. Evaluate based on your specific circumstances and future plans.";
                recommendationClass = 'info-box';
            }
            
            // Additional insights
            const insights = [];
            
            if (effectiveRateReduction >= 1) {
                insights.push("Strong rate reduction of " + effectiveRateReduction.toFixed(2) + "% achieved");
            }
            
            if (newTerm !== remainingYears) {
                if (newTerm > remainingYears) {
                    insights.push(`Extending the term by ${newTerm - remainingYears} years reduces monthly payments but increases total interest`);
                } else {
                    insights.push(`Shortening the term by ${remainingYears - newTerm} years increases monthly payments but saves significant interest`);
                }
            }
            
            if (salaryTransfer) {
                insights.push("Salary transfer benefits applied - consider additional bank products for maximum value");
            }
            
            if (ltv < 50) {
                insights.push("Excellent LTV ratio - you may qualify for premium rates or cash-out refinancing");
            }
            
            // Update schedule summary
            document.getElementById('totalInterestCurrent').textContent = formatCurrency(currentAmortization.totalInterest);
            document.getElementById('totalInterestNew').textContent = formatCurrency(newAmortization.totalInterest);
            document.getElementById('totalInterestSaved').textContent = formatCurrency(currentAmortization.totalInterest - newAmortization.totalInterest);
            
            const currentEndDate = new Date();
            currentEndDate.setMonth(currentEndDate.getMonth() + remainingYears * 12);
            document.getElementById('finalDateCurrent').textContent = currentEndDate.toLocaleDateString('en-AE', { month: 'short', year: 'numeric' });
            
            const newEndDate = new Date();
            newEndDate.setMonth(newEndDate.getMonth() + newTerm * 12);
            document.getElementById('finalDateNew').textContent = newEndDate.toLocaleDateString('en-AE', { month: 'short', year: 'numeric' });
            
            // Update analysis display
            updateAnalysisDisplay({
                currentMonthly: currentAmortization.monthlyPayment,
                newMonthly: newAmortization.monthlyPayment,
                monthlySavings,
                annualSavings,
                totalSavings,
                monthsToBreakeven,
                costs,
                recommendation,
                recommendationClass,
                insights,
                remainingYears,
                newTerm,
                currentAmortization,
                newAmortization
            });
            
            // Display the repayment schedule
            displayRepaymentSchedule(currentAmortization, newAmortization);
            
            // Show results sections
            document.getElementById('resultsSection').classList.remove('hidden');
            document.getElementById('scheduleSection').classList.remove('hidden');
            
            // Generate savings chart
            generateSavingsChart(monthlySavings, costs.total, Math.min(remainingYears, newTerm));
            
            // Generate savings timeline
            generateSavingsTimeline(monthlySavings, costs.total, Math.min(remainingYears, newTerm));
        }
        
        // Update costs display
        function updateCostsDisplay(costs) {
            // Update cost breakdown table
            const costBreakdown = document.getElementById('costBreakdown');
            costBreakdown.innerHTML = `
                <tr>
                    <td>Early Settlement (Current Bank)</td>
                    <td>${formatCurrency(costs.earlySettlement)}</td>
                    <td>${autoCalculationSettings.earlySettlement ? '1% of outstanding or AED 10,000 max (Auto)' : 'Manual entry'}</td>
                </tr>
                <tr>
                    <td>Processing Fee (New Bank)</td>
                    <td>${formatCurrency(costs.processingFee)}</td>
                    <td>${autoCalculationSettings.processingFee ? (costs.processingFee === 0 ? 'Waived for salary transfer (Auto)' : '0.525% standard rate (Auto)') : 'Manual entry'}</td>
                </tr>
                <tr>
                    <td>Property Valuation</td>
                    <td>${formatCurrency(costs.valuation)}</td>
                    <td>Including VAT</td>
                </tr>
                <tr>
                    <td>Mortgage Registration</td>
                    <td>${formatCurrency(costs.mortgageRegistration)}</td>
                    <td>${autoCalculationSettings.mortgageRegistration ? '0.25% + AED 290 (DLD) (Auto)' : 'Manual entry'}</td>
                </tr>
                <tr>
                    <td>Mortgage De-registration</td>
                    <td>${formatCurrency(costs.mortgageDeregistration)}</td>
                    <td>Fixed DLD fee</td>
                </tr>
                <tr>
                    <td>Service Partner Fees</td>
                    <td>${formatCurrency(costs.servicePartner)}</td>
                    <td>Registration services</td>
                </tr>
                <tr>
                    <td>Life Insurance (Year 1)</td>
                    <td>${formatCurrency(costs.lifeInsurance)}</td>
                    <td>${autoCalculationSettings.lifeInsurance ? 'Estimated premium (Auto)' : 'Manual entry'}</td>
                </tr>
                <tr>
                    <td>Legal & Administrative</td>
                    <td>${formatCurrency(costs.legalAdmin)}</td>
                    <td>Documentation & processing</td>
                </tr>
                <tr>
                    <td>Miscellaneous</td>
                    <td>${formatCurrency(costs.miscellaneous)}</td>
                    <td>DEWA, courier, etc.</td>
                </tr>
                <tr style="font-weight: bold; background: #f7fafc;">
                    <td>Total Transfer Costs</td>
                    <td>${formatCurrency(costs.total)}</td>
                    <td>One-time payment required</td>
                </tr>
            `;
        }
        
        // Update analysis display
        function updateAnalysisDisplay(analysis) {
            const analysisGrid = document.getElementById('analysisGrid');
            const breakevenYears = analysis.monthsToBreakeven / 12;
            
            analysisGrid.innerHTML = `
                <div class="result-box ${analysis.monthlySavings > 0 ? 'positive' : 'negative'}">
                    <div class="result-label">Monthly Savings</div>
                    <div class="result-value">${formatCurrency(Math.abs(analysis.monthlySavings))}</div>
                    <div class="result-subtext">${analysis.monthlySavings > 0 ? 'Lower payment' : 'Higher payment'}</div>
                </div>
                <div class="result-box ${analysis.totalSavings > 0 ? 'positive' : 'negative'}">
                    <div class="result-label">Total Net Savings</div>
                    <div class="result-value">${formatCurrency(Math.abs(analysis.totalSavings))}</div>
                    <div class="result-subtext">After all costs</div>
                </div>
                <div class="result-box ${analysis.monthsToBreakeven <= 24 ? 'positive' : (analysis.monthsToBreakeven <= 36 ? 'neutral' : 'negative')}">
                    <div class="result-label">Break-even Period</div>
                    <div class="result-value">${analysis.monthsToBreakeven === Infinity ? 'Never' : analysis.monthsToBreakeven + ' months'}</div>
                    <div class="result-subtext">${analysis.monthsToBreakeven === Infinity ? 'No savings' : (breakevenYears.toFixed(1) + ' years')}</div>
                </div>
                <div class="result-box">
                    <div class="result-label">Interest Savings</div>
                    <div class="result-value">${formatCurrency(analysis.currentAmortization.totalInterest - analysis.newAmortization.totalInterest)}</div>
                    <div class="result-subtext">Over loan term</div>
                </div>
            `;
            
            // Update recommendation
            const recommendationDiv = document.getElementById('recommendation');
            recommendationDiv.innerHTML = `
                <div class="${analysis.recommendationClass}">
                    ${analysis.recommendation}
                    ${analysis.insights.length > 0 ? '<ul style="margin-top: 10px; margin-bottom: 0; padding-left: 20px;">' + 
                        analysis.insights.map(insight => `<li>${insight}</li>`).join('') + '</ul>' : ''}
                </div>
            `;
        }
        
        // Generate savings chart
        function generateSavingsChart(monthlySavings, totalCosts, years) {
            const ctx = document.getElementById('savingsChart').getContext('2d');
            
            // Destroy existing chart if it exists
            if (savingsChart) {
                savingsChart.destroy();
            }
            
            // Generate data points for cumulative savings over time
            const labels = [];
            const cumulativeSavings = [];
            const netPosition = [];
            
            for (let month = 0; month <= years * 12; month += 3) {
                labels.push(month === 0 ? 'Start' : `Month ${month}`);
                const cumSavings = month * monthlySavings;
                cumulativeSavings.push(cumSavings);
                netPosition.push(cumSavings - totalCosts);
            }
            
            // Create new chart
            savingsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Cumulative Savings',
                            data: cumulativeSavings,
                            borderColor: '#667eea',
                            backgroundColor: 'rgba(102, 126, 234, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: 'Net Position (After Costs)',
                            data: netPosition,
                            borderColor: '#38ef7d',
                            backgroundColor: 'rgba(56, 239, 125, 0.1)',
                            borderWidth: 3,
                            tension: 0.4
                        },
                        {
                            label: 'Transfer Costs',
                            data: new Array(labels.length).fill(totalCosts),
                            borderColor: '#f45c43',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': ' + formatCurrency(context.parsed.y);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return formatCurrency(value);
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Generate savings timeline table
        function generateSavingsTimeline(monthlySavings, totalCosts, years) {
            const tbody = document.getElementById('savingsBreakdown');
            let html = '';
            
            const milestones = [6, 12, 18, 24, 36, 48, 60, years * 12];
            
            milestones.forEach(months => {
                if (months <= years * 12) {
                    const cumSavings = months * monthlySavings;
                    const netPosition = cumSavings - totalCosts;
                    const yearLabel = months < 12 ? `${months} months` : `${months/12} year${months/12 > 1 ? 's' : ''}`;
                    
                    html += `
                        <tr>
                            <td>${yearLabel}</td>
                            <td>${formatCurrency(cumSavings)}</td>
                            <td style="color: ${netPosition >= 0 ? '#22543d' : '#c53030'}; font-weight: bold;">
                                ${formatCurrency(netPosition)}
                            </td>
                        </tr>
                    `;
                }
            });
            
            tbody.innerHTML = html;
        }
        
        // Add event listeners for auto-updating costs
        document.getElementById('currentBalance').addEventListener('input', function() {
            updateAutoCalculatedCosts();
            updateTotalCostsDisplay();
        });
        
        document.querySelectorAll('input[name="salaryTransfer"]').forEach(radio => {
            radio.addEventListener('change', function() {
                updateAutoCalculatedCosts();
                updateTotalCostsDisplay();
            });
        });
        
        // Add event listeners for manual cost inputs
        document.querySelectorAll('.cost-input-field').forEach(input => {
            input.addEventListener('input', updateTotalCostsDisplay);
        });
        
        // Add input validation
        document.querySelectorAll('.input-field, .cost-input-field').forEach(input => {
            input.addEventListener('input', function() {
                if (this.type === 'number') {
                    const min = parseFloat(this.min);
                    const max = parseFloat(this.max);
                    const value = parseFloat(this.value);
                    
                    if (!isNaN(min) && value < min) {
                        this.value = min;
                    }
                    if (!isNaN(max) && value > max) {
                        this.value = max;
                    }
                }
            });
        });
        
        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateAutoCalculatedCosts();
            updateTotalCostsDisplay();
            
            // Set initial visual states
            document.querySelectorAll('.cost-input-group').forEach(group => {
                const checkbox = group.querySelector('input[type="checkbox"]');
                if (checkbox && checkbox.checked) {
                    group.classList.add('auto-calculated');
                    const input = group.querySelector('.cost-input-field');
                    if (input) {
                        input.readOnly = true;
                    }
                }
            });
        });
    </script>
</body>
</html>
